<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Расписание тренера - PYon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&family=Playfair+Display:wght@400;700;800&family=Dancing+Script:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/schedule_trainer.css">
</head>
<body class="trainer-schedule-page">

    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar__header">
                <a href="#" class="logo" aria-label="Flow & Form logo">
                    <img src="assets/logo/logo.png" alt="Flow & Form logo" class="logo__img">
                </a>
            </div>
            <!-- Навигация намеренно минимальна и не содержит ссылок на другие страницы -->
            <nav class="sidebar__nav">
                <span class="nav-item active"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Расписание</span></span>
            </nav>
            <div class="sidebar__footer">
                <a href="index.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Выйти</span></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="burger-menu-dashboard" aria-label="Открыть меню">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="page-header">
                    <h1>Мои занятия</h1>
                    <p class="page-subtitle">Просматривайте и управляйте своими классами</p>
                    <div class="trainer-info" id="trainer-info">
                        <span class="trainer-name" id="trainer-name">—</span>
                        <span class="trainer-email" id="trainer-email">—</span>
                    </div>
                </div>
            </header>

            <section class="schedule-content">
                <!-- Desktop calendar view -->
                <div class="desktop-calendar">
                    <div class="month-navigation">
                        <button class="month-nav-btn" id="prev-month">‹</button>
                        <h2 class="current-month" id="current-month">Сентябрь 2024</h2>
                        <button class="month-nav-btn" id="next-month">›</button>
                    </div>

                    <div class="calendar-grid">
                        <div class="calendar-header">
                            <div class="day-name">Пн</div>
                            <div class="day-name">Вт</div>
                            <div class="day-name">Ср</div>
                            <div class="day-name">Чт</div>
                            <div class="day-name">Пт</div>
                            <div class="day-name">Сб</div>
                            <div class="day-name">Вс</div>
                        </div>
                        <div class="calendar-body" id="calendar-body">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Mobile single day view -->
                <div class="mobile-day-view">
                    <div class="mobile-date-selector">
                        <button class="date-nav-btn" id="prev-day">‹</button>
                        <div class="selected-date-info">
                            <input type="date" id="date-picker" class="date-picker">
                            <div class="date-display" id="date-display">Сегодня</div>
                        </div>
                        <button class="date-nav-btn" id="next-day">›</button>
                    </div>
                    
                    <div class="mobile-day-classes" id="mobile-day-classes">
                        <!-- Classes for selected day will be shown here -->
                    </div>
                </div>
            </section>
        </main>
        <div id="class-modal" class="modal">
            <div class="modal-content" id="class-modal-body">
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const page = document.querySelector('.trainer-schedule-page');
            if (!page) return;

            const dayMap = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const monthsRu = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
            const monthsFull = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            let selectedDate = new Date(); // For mobile single day view

            // Load trainer info
            const loadTrainerInfo = async () => {
                try {
                    console.log('Loading trainer info...');
                    const response = await fetch('/api/me', { credentials: 'same-origin' });
                    console.log('Response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Trainer info loaded:', data);
                        console.log('Data keys:', Object.keys(data));
                        console.log('First name:', data.first_name, 'Last name:', data.last_name, 'Email:', data.email);
                        
                        const trainerName = document.getElementById('trainer-name');
                        const trainerEmail = document.getElementById('trainer-email');
                        
                        console.log('Trainer name element:', trainerName);
                        console.log('Trainer email element:', trainerEmail);
                        
                        if (trainerName && data.first_name && data.last_name) {
                            trainerName.textContent = `${data.first_name} ${data.last_name}`;
                            console.log('Set trainer name to:', trainerName.textContent);
                        } else if (trainerName) {
                            trainerName.textContent = 'Тренер';
                            console.log('Set fallback trainer name');
                        }
                        
                        if (trainerEmail && data.email) {
                            trainerEmail.textContent = data.email;
                            console.log('Set trainer email to:', trainerEmail.textContent);
                        } else if (trainerEmail) {
                            trainerEmail.textContent = '—';
                            console.log('Set fallback trainer email');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to load trainer info:', response.status, errorText);
                    }
                } catch (error) {
                    console.error('Error loading trainer info:', error);
                }
            };

            const updateMonthDisplay = () => {
                document.getElementById('current-month').textContent = `${monthsFull[currentMonth]} ${currentYear}`;
            };

            const getDaysInMonth = (year, month) => {
                return new Date(year, month + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (year, month) => {
                return new Date(year, month, 1).getDay();
            };

            const updateCalendar = () => {
                const firstDay = getFirstDayOfMonth(currentYear, currentMonth);
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const today = new Date();
                
                // Calculate days from previous month to show
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const daysInPrevMonth = getDaysInMonth(prevYear, prevMonth);
                
                // Calculate days from next month to show
                const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
                const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                
                const calendarBody = document.getElementById('calendar-body');
                calendarBody.innerHTML = '';
                
                // Create calendar grid (6 weeks x 7 days = 42 cells)
                for (let week = 0; week < 6; week++) {
                    const weekRow = document.createElement('div');
                    weekRow.className = 'calendar-week';
                    
                    for (let day = 0; day < 7; day++) {
                        const cellIndex = week * 7 + day;
                        const dayCell = document.createElement('div');
                        dayCell.className = 'calendar-day';
                        
                        let dayNumber, isCurrentMonth, cellDate;
                        
                        if (cellIndex < firstDay) {
                            // Previous month days
                            dayNumber = daysInPrevMonth - firstDay + cellIndex + 1;
                            isCurrentMonth = false;
                            cellDate = new Date(prevYear, prevMonth, dayNumber);
                        } else if (cellIndex < firstDay + daysInMonth) {
                            // Current month days
                            dayNumber = cellIndex - firstDay + 1;
                            isCurrentMonth = true;
                            cellDate = new Date(currentYear, currentMonth, dayNumber);
                        } else {
                            // Next month days
                            dayNumber = cellIndex - firstDay - daysInMonth + 1;
                            isCurrentMonth = false;
                            cellDate = new Date(nextYear, nextMonth, dayNumber);
                        }
                        
                        dayCell.innerHTML = `
                            <div class="day-number ${!isCurrentMonth ? 'other-month' : ''}">${dayNumber}</div>
                            <div class="day-classes"></div>
                        `;
                        
                        // Highlight today
                        if (isCurrentMonth && 
                            cellDate.getDate() === today.getDate() && 
                            cellDate.getMonth() === today.getMonth() && 
                            cellDate.getFullYear() === today.getFullYear()) {
                            dayCell.classList.add('today');
                        }
                        
                        // Store date info for class rendering - use local date format to avoid timezone issues
                        const year = cellDate.getFullYear();
                        const month = String(cellDate.getMonth() + 1).padStart(2, '0');
                        const dayStr = String(cellDate.getDate()).padStart(2, '0');
                        dayCell.dataset.date = `${year}-${month}-${dayStr}`;
                        dayCell.dataset.isCurrentMonth = isCurrentMonth;
                        
                        weekRow.appendChild(dayCell);
                    }
                    
                    calendarBody.appendChild(weekRow);
                }
            };

            const loadTrainerClasses = async () => {
                try {
                    const startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
                    const endDate = new Date(currentYear, currentMonth + 1, 0).toISOString().split('T')[0];
                    
                    const response = await fetch(`/api/trainer/classes?start_date=${startDate}&end_date=${endDate}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const classes = await response.json();
                        console.log('API Response:', classes);
                        console.log('Start date:', startDate, 'End date:', endDate);
                        renderSchedule(classes);
                    } else {
                        console.error('API Error:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('Error details:', errorText);
                    }
                } catch (error) {
                    console.error('Error loading classes:', error);
                }
            };

            // Mobile single day functions
            const formatDateForDisplay = (date) => {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return 'Сегодня';
                } else if (date.toDateString() === tomorrow.toDateString()) {
                    return 'Завтра';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return 'Вчера';
                } else {
                    const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                    const dayName = days[date.getDay()];
                    const day = date.getDate();
                    const month = monthsRu[date.getMonth()];
                    return `${dayName}, ${day} ${month}`;
                }
            };

            const updateMobileDateDisplay = () => {
                const datePicker = document.getElementById('date-picker');
                const dateDisplay = document.getElementById('date-display');
                
                if (datePicker && dateDisplay) {
                    const dateString = selectedDate.toISOString().split('T')[0];
                    datePicker.value = dateString;
                    dateDisplay.textContent = formatDateForDisplay(selectedDate);
                }
            };

            const loadMobileDayClasses = async () => {
                try {
                    const dateString = selectedDate.toISOString().split('T')[0];
                    const response = await fetch(`/api/trainer/classes?start_date=${dateString}&end_date=${dateString}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const classes = await response.json();
                        renderMobileDayClasses(classes);
                    } else {
                        console.error('API Error:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error loading mobile day classes:', error);
                }
            };

            const renderMobileDayClasses = (classes) => {
                const container = document.getElementById('mobile-day-classes');
                if (!container) return;

                if (!classes || classes.length === 0) {
                    container.innerHTML = `
                        <div class="no-classes-message">
                            <p>На этот день занятий не запланировано</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                classes.forEach(cls => {
                    const classItem = document.createElement('div');
                    classItem.className = 'mobile-class-item';
                    classItem.dataset.classId = cls.id;
                    
                    const timeRange = `${cls.start_time.slice(0,5)} - ${cls.end_time.slice(0,5)}`;
                    let cleanTitle = cls.title;
                    if (cls.type_name && cls.title.includes(cls.type_name)) {
                        cleanTitle = cls.title.replace(cls.type_name, '').trim();
                    }
                    
                    classItem.innerHTML = `
                        <div class="mobile-class-time">${timeRange}</div>
                        <div class="mobile-class-title">${cleanTitle}</div>
                        <div class="mobile-class-info">
                            <div class="mobile-class-type">${cls.type_name || 'Общее'}</div>
                            <div class="mobile-class-count">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01.99L14 10.5l-1-1.5c-.47-.62-1.21-.99-2.01-.99H9.46c-.8 0-1.54.37-2.01.99L5 10.5l-1-1.5C3.53 8.38 2.79 8 2 8H.5L3 15.5V22h2v-6h2.5l2.5-7.5h2l2.5 7.5H15v6h2v-6h2.5l2.5-7.5h2L24 15.5V22h-4z"/>
                                </svg>
                                ${cls.attendees_count || 0}
                            </div>
                        </div>
                    `;
                    
                    classItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        showClassDetails(cls.id);
                    });
                    
                    container.appendChild(classItem);
                });
            };

            const renderSchedule = (classes) => {
                console.log('renderSchedule called with:', classes);
                // Group classes by date
                const classesByDate = {};
                classes.forEach(cls => {
                    // Convert ISO date string to YYYY-MM-DD format
                    let dateKey;
                    if (cls.class_date.includes('T')) {
                        // If it's an ISO string, extract just the date part
                        dateKey = cls.class_date.split('T')[0];
                    } else {
                        // If it's already in YYYY-MM-DD format
                        dateKey = cls.class_date;
                    }
                    console.log(`Grouping class "${cls.title}" for date: ${dateKey} (original: ${cls.class_date})`);
                    if (!classesByDate[dateKey]) {
                        classesByDate[dateKey] = [];
                    }
                    classesByDate[dateKey].push(cls);
                });
                console.log('Classes grouped by date:', classesByDate);

                // Update calendar days
                page.querySelectorAll('.calendar-day').forEach(dayCell => {
                    const dayClasses = dayCell.querySelector('.day-classes');
                    const dateKey = dayCell.dataset.date;
                    
                    console.log(`Checking calendar date: ${dateKey}, has classes: ${!!classesByDate[dateKey]}`);
                    if (classesByDate[dateKey]) {
                        console.log(`Found classes for ${dateKey}:`, classesByDate[dateKey]);
                    }
                    
                    if (classesByDate[dateKey]) {
                        const classes = classesByDate[dateKey];
                        dayClasses.innerHTML = '';
                        
                        classes.forEach(cls => {
                            const classItem = document.createElement('div');
                            classItem.className = 'calendar-class';
                            classItem.dataset.classId = cls.id;
                            const timeRange = `${cls.start_time.slice(0,5)} - ${cls.end_time.slice(0,5)}`;
                            // Убираем тип занятия из заголовка, если он там есть
                            let cleanTitle = cls.title;
                            if (cls.type_name && cls.title.includes(cls.type_name)) {
                                cleanTitle = cls.title.replace(cls.type_name, '').trim();
                            }
                            
                            classItem.innerHTML = `
                                <div class="class-time">${timeRange}</div>
                                <div class="class-title">${cleanTitle}</div>
                                <div class="class-info-row">
                                    <div class="class-type">${cls.type_name || 'Общее'}</div>
                                    <div class="class-count">
                                        <svg class="people-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01.99L14 10.5l-1-1.5c-.47-.62-1.21-.99-2.01-.99H9.46c-.8 0-1.54.37-2.01.99L5 10.5l-1-1.5C3.53 8.38 2.79 8 2 8H.5L3 15.5V22h2v-6h2.5l2.5-7.5h2l2.5 7.5H15v6h2v-6h2.5l2.5-7.5h2L24 15.5V22h-4z"/>
                                        </svg>
                                        ${cls.attendees_count || 0}
                                    </div>
                                </div>
                            `;
                            dayClasses.appendChild(classItem);

                            classItem.addEventListener('click', (e) => {
                                e.stopPropagation();
                                showClassDetails(cls.id);
                            });
                        });
                    }
                });
            };

            const showClassDetails = async (classId) => {
                try {
                    const response = await fetch(`/api/trainer/classes/${classId}/attendees`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const modal = document.getElementById('class-modal');
                        const modalBody = document.getElementById('class-modal-body');
                        
                        // Format date properly
                        let formattedDate;
                        if (data.class.class_date.includes('T')) {
                            formattedDate = new Date(data.class.class_date).toLocaleDateString('ru-RU');
                        } else {
                            formattedDate = new Date(data.class.class_date + 'T00:00:00').toLocaleDateString('ru-RU');
                        }
                        
                        modalBody.innerHTML = `
                            <h2>${data.class.title}</h2>
                            <div class="class-details">
                                <p><strong>Дата:</strong> ${formattedDate}</p>
                                <p><strong>Время:</strong> ${data.class.start_time.slice(0,5)} - ${data.class.end_time.slice(0,5)}</p>
                                <p><strong>Место:</strong> ${data.class.place || 'Не указано'}</p>
                                <p><strong>Тип:</strong> ${data.class.type_name || 'Не указан'}</p>
                                <p><strong>Описание:</strong> ${data.class.description || 'Нет описания'}</p>
                            </div>
                            <h3>Записанные участники (${data.attendees.length}):</h3>
                            <div class="attendees-list">
                                ${data.attendees.map(attendee => `
                                    <div class="attendee-item" data-booking-id="${attendee.booking_id}">
                                        <div class="attendee-info">
                                            <span class="attendee-name">${attendee.first_name} ${attendee.last_name}</span>
                                            <span class="attendee-email">${attendee.email}</span>
                                        </div>
                                        <div class="attendance-controls">
                                            <button class="attendance-btn attended ${attendee.attendance_status === 'attended' ? 'active' : ''}" 
                                                    data-status="attended" title="Присутствовал">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                                </svg>
                                            </button>
                                            <button class="attendance-btn absent ${attendee.attendance_status === 'absent' ? 'active' : ''}" 
                                                    data-status="absent" title="Отсутствовал">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                                </svg>
                                            </button>
                                            <button class="attendance-btn late ${attendee.attendance_status === 'late' ? 'active' : ''}" 
                                                    data-status="late" title="Опоздал">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm4.2 14.2L11 13V7h1.5v5.2l4.5 2.7-.8 1.3z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                        // Add animation class for mobile
                        setTimeout(() => {
                            modal.classList.add('show');
                        }, 10);
                        
                        // Add event listeners for attendance buttons
                        modal.querySelectorAll('.attendance-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                e.preventDefault();
                                const status = btn.dataset.status;
                                const attendeeItem = btn.closest('.attendee-item');
                                const bookingId = attendeeItem.dataset.bookingId;
                                
                                try {
                                    // Get CSRF token from cookies
                                    const csrfToken = document.cookie.split('; ').find(c => c.startsWith('XSRF-TOKEN='))?.split('=')[1];
                                    
                                    const response = await fetch(`/api/trainer/classes/${classId}/attendance/${bookingId}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-XSRF-TOKEN': csrfToken || '',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        credentials: 'same-origin',
                                        body: JSON.stringify({ status })
                                    });
                                    
                                    if (response.ok) {
                                        // Update UI - remove active class from all buttons in this attendee item
                                        attendeeItem.querySelectorAll('.attendance-btn').forEach(b => b.classList.remove('active'));
                                        // Add active class to clicked button
                                        btn.classList.add('active');
                                        
                                        console.log('Attendance marked successfully');
                                    } else {
                                        console.error('Error marking attendance:', response.status);
                                    }
                                } catch (error) {
                                    console.error('Error marking attendance:', error);
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error loading class details:', error);
                }
            };

            // Navigation functions
            const goToPreviousMonth = () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateMonthDisplay();
                updateCalendar();
                loadTrainerClasses();
            };

            const goToNextMonth = () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateMonthDisplay();
                updateCalendar();
                loadTrainerClasses();
            };

            // Desktop event listeners
            document.getElementById('prev-month').addEventListener('click', goToPreviousMonth);
            document.getElementById('next-month').addEventListener('click', goToNextMonth);

            // Mobile event listeners
            const prevDayBtn = document.getElementById('prev-day');
            const nextDayBtn = document.getElementById('next-day');
            const datePicker = document.getElementById('date-picker');

            if (prevDayBtn) {
                prevDayBtn.addEventListener('click', () => {
                    selectedDate.setDate(selectedDate.getDate() - 1);
                    updateMobileDateDisplay();
                    loadMobileDayClasses();
                });
            }

            if (nextDayBtn) {
                nextDayBtn.addEventListener('click', () => {
                    selectedDate.setDate(selectedDate.getDate() + 1);
                    updateMobileDateDisplay();
                    loadMobileDayClasses();
                });
            }

            if (datePicker) {
                datePicker.addEventListener('change', (e) => {
                    selectedDate = new Date(e.target.value);
                    updateMobileDateDisplay();
                    loadMobileDayClasses();
                });
            }

            // Touch/swipe support for mobile
            let touchStartX = 0;
            let touchEndX = 0;
            const minSwipeDistance = 50;

            const calendarGrid = document.querySelector('.calendar-grid');
            if (calendarGrid) {
                calendarGrid.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                });

                calendarGrid.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                });
            }

            const handleSwipe = () => {
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > minSwipeDistance) {
                    // Check if we're on mobile (mobile day view is visible)
                    const mobileDayView = document.querySelector('.mobile-day-view');
                    if (mobileDayView && window.getComputedStyle(mobileDayView).display !== 'none') {
                        // Mobile swipe - navigate days
                        if (swipeDistance > 0) {
                            // Swipe right - go to previous day
                            selectedDate.setDate(selectedDate.getDate() - 1);
                            updateMobileDateDisplay();
                            loadMobileDayClasses();
                        } else {
                            // Swipe left - go to next day
                            selectedDate.setDate(selectedDate.getDate() + 1);
                            updateMobileDateDisplay();
                            loadMobileDayClasses();
                        }
                    } else {
                        // Desktop swipe - navigate months
                        if (swipeDistance > 0) {
                            goToPreviousMonth();
                        } else {
                            goToNextMonth();
                        }
                    }
                }
            };

            // Keyboard navigation support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    goToPreviousMonth();
                } else if (e.key === 'ArrowRight') {
                    goToNextMonth();
                }
            });

            const modal = document.getElementById('class-modal');
            
            const closeModal = () => {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            };
            
            modal.querySelector('.modal-close').addEventListener('click', closeModal);
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal();
            });

            // Mobile modal improvements
            let modalTouchStartY = 0;
            let modalTouchEndY = 0;
            const modalSwipeThreshold = 100;

            modal.addEventListener('touchstart', (e) => {
                modalTouchStartY = e.changedTouches[0].screenY;
            });

            modal.addEventListener('touchend', (e) => {
                modalTouchEndY = e.changedTouches[0].screenY;
                const swipeDistance = modalTouchEndY - modalTouchStartY;
                
                // Swipe down to close modal
                if (swipeDistance > modalSwipeThreshold) {
                    closeModal();
                }
            });

            // Prevent body scroll when modal is open
            const originalBodyOverflow = document.body.style.overflow;
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const modal = document.getElementById('class-modal');
                        if (modal.style.display === 'block') {
                            document.body.style.overflow = 'hidden';
                        } else {
                            document.body.style.overflow = originalBodyOverflow;
                        }
                    }
                });
            });
            
            observer.observe(document.getElementById('class-modal'), {
                attributes: true,
                attributeFilter: ['style']
            });

            // Mobile sidebar toggle
            const burgerMenu = document.querySelector('.burger-menu-dashboard');
            const sidebar = document.querySelector('.sidebar');
            
            if (burgerMenu && sidebar) {
                burgerMenu.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    burgerMenu.classList.toggle('is-active');
                });
                
                // Close sidebar when clicking outside
                document.addEventListener('click', (e) => {
                    if (!sidebar.contains(e.target) && !burgerMenu.contains(e.target)) {
                        sidebar.classList.remove('open');
                        burgerMenu.classList.remove('is-active');
                    }
                });
            }

            // Initialize
            loadTrainerInfo();
            updateMonthDisplay();
            updateCalendar();
            loadTrainerClasses();
            
            // Initialize mobile view
            updateMobileDateDisplay();
            loadMobileDayClasses();
        });
    </script>
</body>
</html>
